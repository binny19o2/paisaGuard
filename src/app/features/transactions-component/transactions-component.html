<app-navbar></app-navbar>

<div class="max-w-4xl mx-auto bg-neutral-50 border-2 border-primary-200 p-6 rounded-xl shadow-md mt-6 relative">
  <div class="flex items-center justify-between mb-4">
    <h2 class="text-xl font-bold">Transactions</h2>
    <button *ngIf="!showForm"
            class="px-4 py-2 rounded-lg bg-primary-600 hover:bg-primary-700 text-white text-sm font-semibold shadow-sm"
            (click)="showForm = true">
      + Add Transaction
    </button>
  </div>

  <!-- Popup message -->
  <div *ngIf="showMessage"
       class="fixed inset-0 flex items-center justify-center bg-black/30 z-40">
    <div class="rounded-lg shadow-lg px-6 py-3 text-sm"
         [ngClass]="messageType === 'success'
                    ? 'bg-emerald-50 text-emerald-800 border border-emerald-200'
                    : 'bg-red-50 text-red-800 border border-red-200'">
      {{ messageText }}
    </div>
  </div>

  <!-- Transactions table -->
  <div *ngIf="!showForm">
    <div class="overflow-x-auto">
      <table class="min-w-full text-sm text-left border border-neutral-200 rounded-lg overflow-hidden">
        <thead class="bg-primary-600 text-white">
          <tr>
            <th class="px-4 py-2">Date</th>
            <th class="px-4 py-2">Type</th>
            <th class="px-4 py-2">Category</th>
            <th class="px-4 py-2">Account</th>
            <th class="px-4 py-2 text-right">Amount</th>
            <th class="px-4 py-2 text-center">Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let txn of (transactions$ | async) | slice:(currentPage - 1) * pageSize:(currentPage) * pageSize"
              class="border-t border-neutral-200">
            <td class="px-4 py-2 text-xs text-gray-600">
              {{ txn.createdAt | date:'short' }}
            </td>
            <td class="px-4 py-2">
              <span class="px-2 py-1 rounded-full text-xs font-medium"
                    [ngClass]="txn.type === 'income'
                                ? 'bg-green-50 text-green-700'
                                : 'bg-red-50 text-red-700'">
                {{ txn.type | titlecase }}
              </span>
            </td>
            <td class="px-4 py-2">
              <span class="px-2 py-1 rounded-full text-xs font-medium"
                    [ngClass]="txn.color">
                {{ txn.category }}
              </span>
            </td>
            <td class="px-4 py-2 text-xs text-gray-700">
              {{ txn.account | titlecase }}
            </td>
            <td class="px-4 py-2 text-right font-semibold"
                [ngClass]="txn.type === 'income' ? 'text-green-600' : 'text-red-600'">
              {{ txn.type === 'income' ? '+' : '-' }} ₹ {{ txn.amount }}
            </td>
            <td class="px-4 py-2 text-right space-x-2">
              <button class="text-xs px-3 py-1 rounded border border-primary-200 text-primary-700 hover:bg-primary-50"
                      (click)="onEdit(txn)">
                Edit
              </button>
              <button class="text-xs px-3 py-1 rounded border border-red-200 text-red-700 hover:bg-red-50"
                      (click)="onDelete(txn.id)">
                Delete
              </button>
            </td>
          </tr>
          <tr *ngIf="(transactions$ | async)?.length === 0">
            <td colspan="6" class="px-4 py-4 text-center text-sm text-gray-500">
              No transactions yet. Click "Add Transaction" to create one.
            </td>
          </tr>
        </tbody>
      </table>
      <div *ngIf="(transactions$ | async)?.length as total"
           class="flex items-center justify-between mt-3 text-xs text-gray-600">
        <span>
          Page {{ currentPage }} of {{ calcMaxPage(total) }}
        </span>
        <div class="space-x-2">
          <button type="button"
                  class="px-3 py-1 rounded border border-neutral-300 bg-white hover:bg-neutral-50 disabled:opacity-50"
                  (click)="onPageChange('prev', total)"
                  [disabled]="currentPage === 1">
            Prev
          </button>
          <button type="button"
                  class="px-3 py-1 rounded border border-neutral-300 bg-white hover:bg-neutral-50 disabled:opacity-50"
                  (click)="onPageChange('next', total)"
                  [disabled]="currentPage >= calcMaxPage(total)">
            Next
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Form -->
  <div *ngIf="showForm">
    <div class="flex items-center justify-between mb-4">
      <h3 class="text-lg font-semibold">Add Transaction</h3>
      <button type="button"
              class="text-sm text-gray-500 hover:text-gray-700"
              (click)="showForm = false">
        ✕ Close
      </button>
    </div>

    <!-- Type -->
    <div class="mb-4">
      <p class="text-sm font-medium text-gray-700 mb-1">Type</p>
      <div class="flex gap-4">
        <label class="flex items-center gap-2 text-sm text-gray-700">
          <input type="radio" name="type" value="income"
                 [(ngModel)]="type" (change)="onTypeChange()">
          Income
        </label>
        <label class="flex items-center gap-2 text-sm text-gray-700">
          <input type="radio" name="type" value="expense"
                 [(ngModel)]="type" (change)="onTypeChange()">
          Expense
        </label>
      </div>
    </div>

    <!-- Amount -->
    <div class="mb-3">
      <label class="block text-sm font-medium text-gray-700 mb-1">Amount</label>
      <input type="number" placeholder="Amount"
             #amount="ngModel"
             class="input w-full border border-neutral-200 bg-neutral-50 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary-400"
             [(ngModel)]="form.amount"
             name="amount"
             required
             min="1">
      <div *ngIf="amount.invalid && amount.touched"
           class="text-xs text-red-600 mt-1">
        Amount is required and must be greater than 0.
      </div>
    </div>

    <!-- Created At -->
    <div class="mb-3">
      <label class="block text-sm font-medium text-gray-700 mb-1">Date &amp; Time</label>
      <input type="datetime-local"
             class="input w-full border border-neutral-200 bg-neutral-50 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary-400"
             [(ngModel)]="form.createdAt"
             name="createdAt">
    </div>

    <!-- Category -->
    <div class="mb-3">
      <label class="block text-sm font-medium text-gray-700 mb-1">Category</label>
      <select class="input w-full border border-neutral-200 bg-neutral-50 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary-400"
              #category="ngModel"
              [(ngModel)]="form.category"
              name="category"
              required>
        <option value="">Select Category</option>
        <option *ngFor="let cat of categories" [value]="cat.name">
          {{ cat.name }}
        </option>
      </select>
      <div *ngIf="category.invalid && category.touched"
           class="text-xs text-red-600 mt-1">
        Please select a category.
      </div>
    </div>

    <!-- Account -->
    <div class="mb-3">
      <label class="block text-sm font-medium text-gray-700 mb-1">Account</label>
      <select class="input w-full border border-neutral-200 bg-neutral-50 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary-400"
              [(ngModel)]="form.account"
              name="account">
        <option value="cash">Cash</option>
        <option value="savings">Savings</option>
        <option value="card">Card</option>
        <option value="upi">UPI</option>
      </select>
    </div>

    <!-- Note -->
    <div class="mb-4">
      <label class="block text-sm font-medium text-gray-700 mb-1">Note</label>
      <textarea placeholder="Note"
                class="input w-full border border-neutral-200 bg-neutral-50 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary-400"
                [(ngModel)]="form.note"
                name="note"></textarea>
    </div>

    <div class="flex gap-3" style="justify-content: center;">
      <button type="button"
              class="px-4 py-2 rounded-lg border border-neutral-300 bg-white text-sm text-gray-700 hover:bg-neutral-50"
              (click)="resetForm()">
        Reset
      </button>

      <button class="px-6 bg-primary-600 hover:bg-primary-700 text-white font-semibold py-2 rounded-lg shadow-sm transition disabled:opacity-60"
              (click)="submit()"
              [disabled]="isSubmitting">
        {{ isSubmitting ? 'Saving...' : 'Save Transaction' }}
      </button>
    </div>
  </div>
</div>
